name: Test Pull Request

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  test:
    name: Run Tests and Validations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        id: unit_tests
        run: |
          go test ./... -v -coverprofile=coverage.out
          echo "COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')" >> $GITHUB_OUTPUT

      - name: Validate config.json syntax
        id: config_validation
        run: |
          if ! jq empty config.json 2>/dev/null; then
            echo "âŒ Invalid JSON syntax in config.json"
            echo "VALID=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… config.json syntax is valid"
          echo "VALID=true" >> $GITHUB_OUTPUT

      - name: Validate config.json schema
        id: schema_validation
        run: |
          # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if ! jq -e '.rss_sources' config.json > /dev/null; then
            echo "âŒ Missing required field: rss_sources"
            exit 1
          fi
          if ! jq -e '.interests' config.json > /dev/null; then
            echo "âŒ Missing required field: interests"
            exit 1
          fi
          if ! jq -e '.notification_settings' config.json > /dev/null; then
            echo "âŒ Missing required field: notification_settings"
            exit 1
          fi

          # é…åˆ—ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
          RSS_COUNT=$(jq '.rss_sources | length' config.json)
          INTEREST_COUNT=$(jq '.interests | length' config.json)

          if [ "$RSS_COUNT" -eq 0 ]; then
            echo "âŒ rss_sources array is empty"
            exit 1
          fi

          if [ "$INTEREST_COUNT" -eq 0 ]; then
            echo "âŒ interests array is empty"
            exit 1
          fi

          echo "âœ… config.json schema is valid"
          echo "RSS_COUNT=$RSS_COUNT" >> $GITHUB_OUTPUT
          echo "INTEREST_COUNT=$INTEREST_COUNT" >> $GITHUB_OUTPUT

      - name: Check config.json values
        id: value_check
        run: |
          WARNINGS=""

          # min_relevance_scoreã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
          MIN_SCORE=$(jq '.notification_settings.min_relevance_score' config.json)
          if [ "$MIN_SCORE" -lt 0 ] || [ "$MIN_SCORE" -gt 100 ]; then
            WARNING_MSG="min_relevance_score ($MIN_SCORE) should be between 0 and 100"
            WARNINGS="${WARNINGS}- ${WARNING_MSG}\n"
            echo "âš ï¸ Warning: ${WARNING_MSG}"
          fi

          # max_articlesã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
          MAX_ARTICLES=$(jq '.notification_settings.max_articles' config.json)
          if [ "$MAX_ARTICLES" -lt 1 ] || [ "$MAX_ARTICLES" -gt 10 ]; then
            WARNING_MSG="max_articles ($MAX_ARTICLES) should be between 1 and 10"
            WARNINGS="${WARNINGS}- ${WARNING_MSG}\n"
            echo "âš ï¸ Warning: ${WARNING_MSG}"
          fi

          if [ -z "$WARNINGS" ]; then
            echo "âœ… Config values checked - all values are within valid ranges"
            echo "HAS_WARNINGS=false" >> $GITHUB_OUTPUT
          else
            echo "HAS_WARNINGS=true" >> $GITHUB_OUTPUT
            echo "WARNINGS<<EOF" >> $GITHUB_OUTPUT
            echo -e "$WARNINGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.unit_tests.outputs.COVERAGE }}' || 'N/A';
            const configValid = '${{ steps.config_validation.outputs.VALID }}' === 'true';
            const rssCount = '${{ steps.schema_validation.outputs.RSS_COUNT }}' || '0';
            const interestCount = '${{ steps.schema_validation.outputs.INTEREST_COUNT }}' || '0';
            const hasWarnings = '${{ steps.value_check.outputs.HAS_WARNINGS }}' === 'true';
            const warnings = `${{ steps.value_check.outputs.WARNINGS }}`;

            let warningsSection = '';
            if (hasWarnings) {
              warningsSection = `\n### âš ï¸ è¨­å®šå€¤ã®è­¦å‘Š\n${warnings}\nè¨­å®šå€¤ã¯æœ‰åŠ¹ç¯„å›²å¤–ã§ã™ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å¯èƒ½ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`;
            }

            const body = `## ãƒ†ã‚¹ãƒˆçµæœ ğŸ§ª

            ### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
            ${coverage !== 'N/A' ? 'âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒåˆæ ¼ã—ã¾ã—ãŸ' : 'âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ'}
            - ã‚«ãƒãƒ¬ãƒƒã‚¸: ${coverage}

            ### config.jsonæ¤œè¨¼
            ${configValid ? 'âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ‰åŠ¹ã§ã™' : 'âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã§ã™'}
            - RSSã‚½ãƒ¼ã‚¹æ•°: ${rssCount}
            - èˆˆå‘³ãƒˆãƒ”ãƒƒã‚¯æ•°: ${interestCount}
            ${warningsSection}

            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            ${configValid ?
              'âœ… ã“ã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚\nç¿Œæœ9:00 JSTã‹ã‚‰æ–°ã—ã„è¨­å®šã§è¨˜äº‹ã‚­ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚' :
              'âŒ config.jsonã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Generate coverage HTML report
        if: success()
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage reports
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html
          retention-days: 30
